<div class="row">
    <div class="col-md-8">
        <form id="priceForm" novalidate>
            <div id="notifyArea" class="position-fixed top-0 end-0 p-3" style="z-index:1080;"></div>

            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <strong>Fiyat Tahmin Formu</strong>
                </div>

                <div class="card-body">

                    <div class="mb-2">
                        <label class="form-label small">Marka</label>
                        <select id="markaId" class="form-select form-select-sm"></select>
                    </div>

                    <div class="mb-2">
                        <label class="form-label small">Seri</label>
                        <select id="seriId" class="form-select form-select-sm"></select>
                    </div>

                    <div class="mb-2">
                        <label class="form-label small">Model</label>
                        <select id="modelId" class="form-select form-select-sm"></select>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-2">
                            <label class="form-label small">Yıl</label>
                            <input id="yil" type="number" class="form-control form-control-sm" value="2018">
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label small">Kilometre</label>
                            <input id="kilometre" type="number" class="form-control form-control-sm" value="150000">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-2">
                            <label class="form-label small">Yakıt Tipi</label>
                            <select id="yakitTipi" class="form-select form-select-sm">
                                <option value="0">Benzin</option>
                                <option value="1" selected>Dizel</option>
                            </select>
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label small">Vites Tipi</label>
                            <select id="vitesTipi" class="form-select form-select-sm">
                                <option value="0" selected>Manuel</option>
                                <option value="1">Otomatik</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-2">
                        <label class="form-label small">Hasar Durumu</label>
                        <select id="hasarDurumu" class="form-select form-select-sm">
                            <option value="0">Orijinal</option>
                            <option value="1">Boya / Değişen</option>
                        </select>
                    </div>

                    <div class="mb-2">
                        <label class="form-label small">Takasa Uygun</label>
                        <select id="takas" class="form-select form-select-sm">
                            <option value="true">Evet</option>
                            <option value="false">Hayır</option>
                        </select>
                    </div>

                    <div class="mb-2">
                        <label class="form-label small">Kimden</label>
                        <select id="kimden" class="form-select form-select-sm">
                            <option value="Galeriden">Galeriden</option>
                            <option value="Sahibinden">Sahibinden</option>
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-2">
                            <label class="form-label small">Motor Hacmi (cc)</label>
                            <input id="motorHacmi" type="number" class="form-control form-control-sm" value="1600">
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label small">Motor Gücü (HP)</label>
                            <input id="motorGucu" type="number" class="form-control form-control-sm" value="136">
                        </div>
                    </div>

                    <button type="button" id="calcBtn" class="btn btn-primary btn-sm w-100 mt-2">
                        Hesapla
                    </button>

                </div>
            </div>
        </form>
    </div>

    
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const apiUrl = 'http://localhost:3000/api/predict';
    const el = id => document.getElementById(id);

    const dataMap = {
        5: { name: 'Ford', series: {
            12: { name: 'Focus', models: {
                45: '1.6 TDCi',
                46: '1.5 EcoBoost',
                47: '1.0 EcoBoost'
            }},
            13: { name: 'Fiesta', models: {
                48: '1.4 TDCi',
                49: '1.0 EcoBoost'
            }}
        }},
        6: { name: 'Renault', series: {
            20: { name: 'Clio', models: {
                60: '1.5 dCi',
                61: '1.3 TCe'
            }},
            21: { name: 'Megane', models: {
                62: '1.6 dCi',
                63: '1.3 TCe'
            }}
        }},
        7: { name: 'Volkswagen', series: {
            30: { name: 'Golf', models: {
                70: '1.6 TDI',
                71: '1.4 TSI'
            }},
            31: { name: 'Passat', models: {
                72: '1.6 TDI',
                73: '2.0 TDI'
            }}
        }},
        8: { name: 'Hyundai', series: {
            40: { name: 'i20', models: {
                80: '1.4 CRDi',
                81: '1.2 MPI'
            }},
            41: { name: 'i30', models: {
                82: '1.6 CRDi'
            }}
        }}
    };

    function fillSelect(select, items) {
        select.innerHTML = '';
        Object.entries(items).forEach(([id, obj]) => {
            const o = document.createElement('option');
            o.value = id;
            o.textContent = obj.name || obj;
            select.appendChild(o);
        });
    }

    fillSelect(el('markaId'), dataMap);

    const firstBrand = Object.keys(dataMap)[0];
    fillSelect(el('seriId'), dataMap[firstBrand].series);

    const firstSeries = Object.keys(dataMap[firstBrand].series)[0];
    fillSelect(el('modelId'), dataMap[firstBrand].series[firstSeries].models);

    el('markaId').addEventListener('change', e => {
        const brand = dataMap[e.target.value];
        fillSelect(el('seriId'), brand.series);
        el('seriId').dispatchEvent(new Event('change'));
    });

    el('seriId').addEventListener('change', e => {
        const brandId = el('markaId').value;
        fillSelect(
            el('modelId'),
            dataMap[brandId].series[e.target.value].models
        );
    });

    el('calcBtn').addEventListener('click', async () => {
        const payload = {
            marka_id: Number(el('markaId').value),
            seri_id: Number(el('seriId').value),
            model_id: Number(el('modelId').value),
            yil: Number(el('yil').value),
            kilometre: Number(el('kilometre').value),
            vites_tipi_id: Number(el('vitesTipi').value),
            yakit_tipi_id: Number(el('yakitTipi').value),
            motor_hacmi: Number(el('motorHacmi').value),
            motor_gucu: Number(el('motorGucu').value),
            hasar_durumu: Number(el('hasarDurumu').value),
            takasa_uygun: el('takas').value === 'true',
            kimden: el('kimden').value
        };

        const res = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(r => r.json());

        document.dispatchEvent(new CustomEvent('priceResult', { detail: res }));
    });
});
</script>